/*! WordDraw v.1-beta (20101008) <http://burzak.com/proj/worddraw/> */
var WordDraw=$buildClass("WordDraw",null,function(){this.__add__($PUBLIC,"__new__",function(a,d,g,b,l,f,e,o,q,r){a.toolbar=document.getElementById(g);a.container=document.getElementById(b);try{a.canvas=document.createElement("drawform")}catch(h){r&&r(h);return}a.canvas.id=l;a.canvas.width=o;a.canvas.height=q;a.canvas.name=f;if(e)a.canvas.src=e;a.ctx=a.canvas.getContext("default");a.plugin_url=d;a.container.appendChild(a.canvas);a.buildToolbar();a.defStrokeOpacity=80;a.setStrokeOpacity(a.defStrokeOpacity);
a.setStrokeColor(a.ctx.strokeStyle.toHex());a.defFillOpacity=90;a.setFillOpacity(a.defFillOpacity);a.setFillColor(a.ctx.fillStyle.toHex());a.deflineWidth=a.ctx.lineWidth;a.setLineWidth(a.deflineWidth)});this.__add__($PUBLIC,"buildToolbar",function(a){a.toolbar.innerHTML="";var d=document.createElement("div"),g=document.createElement("div"),b=document.createElement("div");d.id="wd-toolbar-buttons";g.id="wd-toolbar-common";b.id="wd-toolbar-tool";var l=[{tool:"pencil",title:"Draw freehand lines",action:function(){b.innerHTML=
"";a.ctx.setTool(this.tool)},sprite:0},{tool:"pen",title:"Draw calligraphic or brush strokes",pen:"standard",daubSize:20,daubStep:5,light:false,shape:"circle","rect-brush":a.plugin_url+"/rect-brush.png","circle-brush":a.plugin_url+"/circle-brush.png",action:function(){b.innerHTML=['<label>Shape <img src="',this.config["circle-brush"],'" id="circle-brush" class="brush-shape" />   <img src="',this.config["rect-brush"],'" id="rect-brush" class="brush-shape" /></label> &nbsp;<label for="brush-size">Size <input title="Brush size" type="text" value="20" size="3" name="brush-size" id="brush-size" /></label>   <label for="brush-step">Step <input title="Brush step" type="text" value="5" size="3" name="brush-step" id="brush-step" /></label>',
this.tool=="pen"?'   <label for="light-brush">Light <input title="Light brush" type="checkbox" name="light-brush" id="light-brush" /></label>':""].join("");var c=jQuery("#circle-brush",b),m=jQuery("#rect-brush",b),k=jQuery("#brush-size",b).keydown(h),n=jQuery("#brush-step",b).keydown(h),j=jQuery("#light-brush",b).keydown(h),i=this;c.click(function(){i.config.shape=a.ctx.tool.pen.shape="circle"});m.click(function(){i.config.shape=a.ctx.tool.pen.shape="rect"});j.change(function(){a.ctx.tool.compositeOperation=
this.checked?"light":"normal";i.config.light=this.checked});k.keyup(function(){var p=this.value;if(p!="")if(isNaN(p))this.value=i.config.daubSize;else i.config.daubSize=a.ctx.tool.pen.daubSize=Number(p)});n.keyup(function(){var p=this.value;if(p!="")if(isNaN(p))this.value=i.config.daubSize;else i.config.daubStep=a.ctx.tool.pen.daubStep=Number(p)});c="normal";if(i.config.light){j.attr("checked","1");c="light"}n.val(i.config.daubStep);k.val(i.config.daubSize);a.ctx.setTool(this.tool,i.config.pen,i.config,
c)},sprite:1},{tool:"fill",title:"Fill contiguous areas or replace color",tolerance:20,contiguous:true,action:function(){b.innerHTML='<label for="fill-tolerance">Tolerance <input title="Tolerance" type="text" value="" size="3" name="fill-tolerance" id="fill-tolerance" /></label>   <label for="fill-contiguous">Contiguous <input title="Contiguous" type="checkbox" name="fill-contiguous" id="fill-contiguous" /></label>';var c=jQuery("#fill-tolerance",b).keydown(h),m=jQuery("#fill-contiguous",b).keydown(h),
k=this;c.keyup(function(){var n=this.value;if(n!="")if(isNaN(n))this.value=k.config.tolerance;else k.config.tolerance=a.ctx.tool.tolerance=Number(n)});m.change(function(){a.ctx.tool.contiguous=k.config.contiguous=this.checked});k.config.contiguous&&m.attr("checked","1");c.val(k.config.tolerance);a.ctx.setTool(this.tool,k.config.contiguous,k.config.tolerance)},sprite:2},{tool:"rectangle",title:"Draw rectangle",action:function(){b.innerHTML="";a.ctx.setTool(this.tool)},sprite:3},{tool:"ellipse",title:"Draw ellipse",
action:function(){b.innerHTML="";a.ctx.setTool(this.tool)},sprite:4},{tool:"path",title:"Draw path",action:function(){b.innerHTML="";a.ctx.setTool(this.tool)},sprite:9},{tool:"image",title:"Draw image",src:"",action:function(){b.innerHTML=['<label for="image-url">Image URL <input type="text" title="Image URL" name="image-url" id="image-url" size="45"','value="'+this.config.src+'"',"</label>"].join("");var c=this;jQuery("#image-url",b).keydown(h).blur(function(){c.config.src=this.value;a.ctx.tool.src=
c.config.src});a.ctx.setTool(c.tool,c.config.src)},sprite:5},{tool:"text",title:"Add text",fontFace:"sans-serif",fontSize:15,bold:false,italic:false,action:function(){b.innerHTML='<label for="font-face">Font face <select name=\'font-face\' id=\'font-face\'><option value=\'sans-serif\'>Sans Serif&nbsp;&nbsp;&nbsp;</option><option value=\'serif\'>Serif&nbsp;&nbsp;&nbsp</option></select></label>   <label for="text-size">Size <input title="Text size" type="text" value="" size="3" name="text-size" id="text-size" /></label>   <label for="text-bold">Bold <input title="Text bold" type="checkbox" name="text-bold" id="text-bold" /></label>   <label for="text-italic">Italic</label> <input title="Text italic" type="checkbox" name="text-italic" id="text-italic" /></label>';
var c=jQuery("#font-face",b).keydown(h),m=jQuery("#text-size",b).keydown(h),k=jQuery("#text-bold",b).keydown(h),n=jQuery("#text-italic",b).keydown(h),j=this;m.keyup(function(){var i=this.value;if(i!="")if(isNaN(i))this.value=j.config.fontSize;else j.config.fontSize=a.ctx.tool.fontSize=Number(i)});c.change(function(){j.config.fontFace=a.ctx.tool.fontFace=this.value});k.change(function(){a.ctx.tool.bold=j.config.bold=this.checked});n.change(function(){a.ctx.tool.italic=j.config.italic=this.checked});
j.config.bold&&k.attr("checked","1");j.config.italic&&n.attr("checked","1");jQuery("#font-face [value='"+j.config.fontFace+"']",b).attr("selected","selected");m.val(j.config.fontSize);a.ctx.setTool(j.tool,j.config)},sprite:6},{tool:"marquee",title:"Select area",action:function(){b.innerHTML="";a.ctx.setTool(this.tool)},sprite:7},{tool:"move",title:"Move selection or entire image",action:function(){b.innerHTML="";a.ctx.setTool(this.tool)},sprite:15},{tool:"eraser",title:"Erase",sprite:8},{tool:"clear",
title:"Clear whole canvas or selected area",action:function(){a.ctx.clear()},sprite:10},{tool:"colorpicker",title:"Pick color from image",action:function(){b.innerHTML='<label for="picked-color">Color value    <input title="Selected color value, click on canvas to get" type="text" value="#" size="8" name="color-value" id="color-value"/></label>';var c=jQuery("#color-value",b).keydown(h);a.ctx.setTool(this.tool,function(m){c.val(["#",a.toHex(m[0]),a.toHex(m[1]),a.toHex(m[2])].join(""))})},sprite:13},
{tool:"undo",title:"Undo changes",permanent:false,action:function(){a.ctx.undo()},sprite:12},{tool:"redo",title:"Redo changes",permanent:false,action:function(){a.ctx.redo()},sprite:14}],f=l[10],e=l[1];f.action=e.action;f["rect-brush"]=e["rect-brush"];f["circle-brush"]=e["circle-brush"];f.daubSize=e.daubSize;f.daubStep=e.daubStep;f.shape=e.shape;var o;for(f=0;f<l.length;f++){e=document.createElement("input");e.config=l[f];e.id="wd-but-"+e.config.tool;e.onclick=e.config.action;e.className="wd-button";
e.tool=e.config.tool;e.type="button";e.title=e.config.title;var q=e.config.sprite*26,r="transparent url("+a.plugin_url+"/tools-icons.png) -"+(q+1)+"px 0px no-repeat";q="transparent url("+a.plugin_url+"/tools-icons.png) -"+(q+1)+"px -26px no-repeat";e.style.background=r;d.appendChild(e);e.st_over=q;e.st_out=r;e.permanent=l[f].permanent==undefined?true:l[f].permanent;e.onmousedown=function(){if(this.permanent&&o){o.active=false;o.style.background=o.st_out;o.style.borderColor="#c3c3c3"}if(this.permanent){o=
this;this.active=true}this.style.background=this.st_over;this.style.borderColor="black"};e.onmouseup=function(){if(!this.permanent){this.style.borderColor="#c3c3c3";this.style.background=this.st_out}};e.onmouseover=function(){this.style.background=this.st_over};e.onmouseout=function(){if(!this.active)this.style.background=this.st_out}}g.innerHTML='<label for=\'stroke-color\'>Stroke color <input title="Click to picking color" type="text" name="stroke-color" id="stroke-color" size="8" value="#" /></label><div id="strokeColorPickerDiv" style="z-index: 200; background:#eee; border:1px solid #ccc; position:absolute; display:none;"></div>    <label for=\'fill-color\'>Fill color <input title="Click to picking color" type="text" name="fill-color" size="8" id="fill-color" value="#" /></label><div id="fillColorPickerDiv" style="z-index: 100; background:#eee; border:1px solid #ccc; position:absolute; display:none;"></div>    <label for=\'stroke-opacity\'>Stroke opacity <input title="Stroke opacity" type="text" name="stroke-opacity" id="stroke-opacity" size="3" value="" /></label>    <label for=\'fill-opacity\'>Fill opacity <input title="Fill opacity" type="text" name="fill-opacity" size="3" id="fill-opacity" value="" /></label>    <label for=\'line-width\'>Line width <input type="text" name="line-width" id="line-width" size="3" value="" /></label>';
a.toolbar.appendChild(d);a.toolbar.appendChild(g);a.toolbar.appendChild(b);a.strokeColorInput=g.children[0].children[0];a.strokeColorPickerDiv=g.children[1];a.fillColorInput=g.children[2].children[0];a.fillColorPickerDiv=g.children[3];a.strokeOpacityInput=g.children[4].children[0];a.fillOpacityInput=g.children[5].children[0];a.lineWidthInput=g.children[6].children[0];a.farbtasticSetup();var h=function(c){return c.keyCode==13?false:true};jQuery(a.strokeColorInput).keydown(h);jQuery(a.fillColorInput).keydown(h);
jQuery(a.strokeOpacityInput).keyup(function(){var c=jQuery(a.strokeOpacityInput).val();if(c!=""){c=isNaN(c)?a.defStrokeOpacity:parseInt(c)%101;a.setStrokeOpacity(c)}}).keydown(h);jQuery(a.fillOpacityInput).keyup(function(){var c=jQuery(a.fillOpacityInput).val();if(c!=""){c=isNaN(c)?a.defFillOpacity:parseInt(c)%101;a.setFillOpacity(c)}}).keydown(h);jQuery(a.lineWidthInput).keyup(function(){var c=jQuery(a.lineWidthInput).val();if(c!=""){c=isNaN(c)?a.defLineWidth:parseInt(c);a.setLineWidth(c)}}).keydown(h)});
this.__add__($PUBLIC,"farbtasticSetup",function(a){jQuery(a.strokeColorInput).click(function(){jQuery(a.strokeColorPickerDiv).show();return false});jQuery(a.fillColorInput).click(function(){jQuery(a.fillColorPickerDiv).show();return false});var d=function(b){var l=jQuery(b).val(),f=l;if(f[0]!="#")f="#"+f;f=f.replace(/[^#a-fA-F0-9]+/,"");f!=l&&jQuery(b).val(f);if(f.length==4||f.length==7)return f};jQuery(a.strokeColorInput).keyup(function(){a.setStrokeColor(d(a.strokeColorInput))});jQuery(a.fillColorInput).keyup(function(){a.setFillColor(d(a.fillColorInput))});
a.ftStrokeColor=jQuery.farbtastic(a.strokeColorPickerDiv,function(b){a.setStrokeColor(b)});a.ftFillColor=jQuery.farbtastic(a.fillColorPickerDiv,function(b){a.setFillColor(b)});var g=function(){jQuery(document).unbind("mousemove",a.ftStrokeColor.mousemove).unbind("mouseup",a.ftStrokeColor.mouseup).unbind("mousemove",a.ftFillColor.mousemove).unbind("mouseup",a.ftFillColor.mouseup)};g();jQuery([a.strokeColorPickerDiv,a.fillColorPickerDiv]).bind("mousedown",function(){jQuery(document).bind("mousemove",
a.ftStrokeColor.mousemove).bind("mouseup",a.ftStrokeColor.mouseup).bind("mousemove",a.ftFillColor.mousemove).bind("mouseup",a.ftFillColor.mouseup)});jQuery([a.strokeColorPickerDiv,a.fillColorPickerDiv]).bind("mousedown",g);jQuery(document).mousedown(function(){jQuery(a.fillColorPickerDiv).each(function(){jQuery(this).css("display")=="block"&&jQuery(this).fadeOut(2)});jQuery(a.strokeColorPickerDiv).each(function(){jQuery(this).css("display")=="block"&&jQuery(this).fadeOut(2)})})});this.__add__($PUBLIC,
"setStrokeColor",function(a,d){a.ftStrokeColor.setColor(d);jQuery(a.strokeColorInput).val(d);var g=jQuery(a.strokeOpacityInput).val();a.ctx.setStrokeStyle(d);a.ctx.setStrokeOpacity(a.opacityToValue(g))});this.__add__($PUBLIC,"setFillColor",function(a,d){a.ftFillColor.setColor(d);jQuery(a.fillColorInput).val(d);var g=jQuery(a.fillOpacityInput).val();a.ctx.setFillStyle(d);a.ctx.setFillOpacity(a.opacityToValue(g))});this.__add__($PUBLIC,"setStrokeOpacity",function(a,d){jQuery(a.strokeOpacityInput).val(d);
a.ctx.setStrokeOpacity(a.opacityToValue(d))});this.__add__($PUBLIC,"setFillOpacity",function(a,d){jQuery(a.fillOpacityInput).val(d);a.ctx.setFillOpacity(a.opacityToValue(d))});this.__add__($PUBLIC,"setLineWidth",function(a,d){jQuery(a.lineWidthInput).val(d);a.ctx.setLineWidth(d)});this.__add__($PUBLIC,"opacityToValue",function(a,d){return Math.round(Number(d)/100*255)});this.__add__($PUBLIC,"opacityToRatio",function(a,d){var g=Number(d)/255;return Math.round(g*100)});this.__add__($PUBLIC,"toHex",
function(a,d){return Number(d).toString(16)})});
